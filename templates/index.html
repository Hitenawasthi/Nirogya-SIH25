<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Public Health Assistant | Smart India Hackathon 2025</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Modern Header -->
    <header class="modern-header">
        <div class="header-container">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                    <div class="logo-text">
                        <h1>Nirogya</h1>
                        <span class="tagline">Smart India Hackathon 2025</span>
                    </div>
            </div>
            <nav class="main-nav">
                <a href="/" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="/chat" class="nav-item active">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                </a>
                <a href="/doctors" class="nav-item">
                    <i class="fas fa-user-md"></i>
                    <span>Connect with Doctor</span>
                </a>
                <a href="/hospitals" class="nav-item">
                    <i class="fas fa-hospital"></i>
                    <span>For Hospitals</span>
                </a>
                <a href="/about" class="nav-item">
                    <i class="fas fa-info-circle"></i>
                    <span>About & Contact</span>
                </a>
            </nav>
        </div>
    </header>

    <!-- Main Chat Interface -->
    <main class="chat-main">
        <!-- Health Dashboard Sidebar -->
        <aside class="health-sidebar">
            <div class="sidebar-header">
                <h3>Health Dashboard</h3>
                <button class="refresh-btn" onclick="refreshHealthData()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <!-- Health Metrics -->
            <div class="health-metrics" id="healthMetrics">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="metric-content">
                        <h4>Heart Rate</h4>
                        <span class="metric-value">72 bpm</span>
                        <p class="metric-status">Stable</p>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-thermometer-half"></i>
                    </div>
                    <div class="metric-content">
                        <h4>Body Temp</h4>
                        <span class="metric-value">98.6°F</span>
                        <p class="metric-status">Normal</p>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="metric-content">
                        <h4>Blood Sugar</h4>
                        <span class="metric-value">95 mg/dL</span>
                        <p class="metric-status">Healthy</p>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-weight"></i>
                    </div>
                    <div class="metric-content">
                        <h4>BMI</h4>
                        <span class="metric-value">22.5</span>
                        <p class="metric-status">Optimal</p>
                    </div>
                </div>
            </div>

            <!-- Health Tips Widget -->
            <div class="health-tips-widget">
                <div class="widget-header">
                    <i class="fas fa-lightbulb"></i>
                    <span>Health Tips</span>
                </div>
                <div class="tips-container" id="healthTipsContainer">
                    <div class="health-tip active">
                        <i class="fas fa-lightbulb"></i>
                        <span>Stay hydrated! Drink 8-10 glasses of water daily for optimal health.</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Chat Area -->
        <section class="chat-area">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="chat-title">
                            <div class="chat-info">
                                <h2>AI Health Assistant</h2>
                                <span class="status">Online</span>
                            </div>
                        </div>
                    </div>

            <!-- Chat Messages Container -->
            <div class="chat-messages-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome message from AI -->
                    <div class="message bot fade-in">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                Hi! 👋 I'm your AI Health Assistant. I'm here to help you with health-related questions, analyze symptoms, and provide medical insights. How can I assist you today?
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                </div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="typing-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="typing-text">AI is thinking...</span>
                    </div>
                </div>
            </div>

        <!-- Chat Input Container -->
        <div class="chat-input-container">
            <div class="input-wrapper">
                <div class="input-field">
                    <input type="text" id="messageInput" placeholder="Ask me about your health concerns..." maxlength="500">
                    <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;">
                    <button id="attachmentButton" class="attachment-btn" title="Upload medical report">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button id="sendButton" class="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <div class="input-footer">
                <small>
                    <i class="fas fa-shield-alt"></i>
                    Your conversations are secure and private
                </small>
            </div>
        </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-left">
                    <p>&copy; 2025 HealthBot AI - Smart India Hackathon Project</p>
                </div>
                <div class="footer-right">
                    <span>Powered by Google Gemini AI</span>
                    <i class="fas fa-brain"></i>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Handle AI Analysis Data from Home Page
        document.addEventListener('DOMContentLoaded', function() {
            const aiAnalysisData = sessionStorage.getItem('aiAnalysisData');
            const userData = sessionStorage.getItem('userData');
            
            // Check if user is logged in - but don't block the chat
            if (!userData) {
                // Show a simple welcome message instead of login prompt
                console.log('User not logged in, showing basic welcome');
                // The static welcome message in HTML will show
            }
            
            // Initialize chat functionality
            initializeChat();
            
            // Test function to verify chat is working
            setTimeout(() => {
                console.log('Testing chat functionality...');
                const chatMessages = document.getElementById('chatMessages');
                console.log('Chat messages container found:', chatMessages);
                if (chatMessages) {
                    console.log('Chat messages children:', chatMessages.children.length);
                }
            }, 1000);
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    
                    // Create a personalized welcome message
                    let welcomeMessage = `Hello ${user.fullName}! 👋 Welcome to your personalized health journey with Nirogya. `;
                    welcomeMessage += `I'm your AI MedBuddy, and I'm here to help you with health insights, prescription analysis, and connecting you with experienced doctors for one-on-one consultations. `;
                    
                    if (aiAnalysisData) {
                        const data = JSON.parse(aiAnalysisData);
                        
                        if (data.symptoms) {
                            welcomeMessage += `I see you mentioned: "${data.symptoms}". `;
                        }
                        
                        if (data.medications) {
                            welcomeMessage += `You're currently taking: ${data.medications}. `;
                        }
                        
                        if (data.hasPrescription) {
                            welcomeMessage += "I've received your prescription for analysis. ";
                        }
                        
                        if (data.hasPhoto) {
                            welcomeMessage += "I've received your photo for analysis. ";
                        }
                        
                        // Clear the analysis data
                        sessionStorage.removeItem('aiAnalysisData');
                    }
                    
                    welcomeMessage += "How can I assist you today? Feel free to ask me any questions about your health, medications, or symptoms. I can also help you connect with our network of experienced doctors for personalized consultations.";
                    
                    // Add the welcome message to the chat
                    setTimeout(() => {
                        addMessage(welcomeMessage, 'bot');
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error parsing user data:', error);
                }
            } else if (aiAnalysisData) {
                // Fallback for users who didn't register
                try {
                    const data = JSON.parse(aiAnalysisData);
                    
                    let welcomeMessage = "Welcome! I've received your information and I'm ready to help. ";
                    
                    if (data.symptoms) {
                        welcomeMessage += `I see you mentioned: "${data.symptoms}". `;
                    }
                    
                    if (data.medications) {
                        welcomeMessage += `You're currently taking: ${data.medications}. `;
                    }
                    
                    if (data.hasPrescription) {
                        welcomeMessage += "I've received your prescription for analysis. ";
                    }
                    
                    if (data.hasPhoto) {
                        welcomeMessage += "I've received your photo for analysis. ";
                    }
                    
                    welcomeMessage += "How can I assist you further? Feel free to ask me any questions about your health, medications, or symptoms.";
                    
                    // Add the welcome message to the chat
                    setTimeout(() => {
                        addMessage(welcomeMessage, 'bot');
                    }, 1000);
                    
                    // Clear the session storage
                    sessionStorage.removeItem('aiAnalysisData');
                } catch (error) {
                    console.error('Error parsing AI analysis data:', error);
                }
            }
        });
        
        // Function to format bot messages with proper HTML
        function formatBotMessage(text) {
            // Convert line breaks to <br> tags
            let formatted = text.replace(/\n/g, '<br>');
            
            // Convert bullet points with bold headers (like "**Rest:**")
            formatted = formatted.replace(/\* \*\*(.*?)\*\*:?/g, '<li><strong>$1</strong></li>');
            
            // Convert regular bullet points
            formatted = formatted.replace(/\* (.*?)(?=<br>|$)/g, '<li>$1</li>');
            
            // Wrap consecutive list items in <ul> tags
            formatted = formatted.replace(/(<li>.*<\/li>)(<br><li>.*<\/li>)*/g, function(match) {
                return '<ul>' + match.replace(/<br>/g, '') + '</ul>';
            });
            
            // Convert bold text (but not the ones we already converted)
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert italic text
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Add spacing between sections
            formatted = formatted.replace(/<br><br>/g, '<br><br>');
            
            return formatted;
        }
        
        function addMessage(message, sender) {
            console.log('Adding message:', message, 'from:', sender);
            const chatMessages = document.getElementById('chatMessages');
            console.log('Chat messages container:', chatMessages);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender} fade-in`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            // Format the message for better readability
            if (sender === 'bot') {
                messageText.innerHTML = formatBotMessage(message);
            } else {
                messageText.textContent = message;
            }
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            content.appendChild(messageText);
            content.appendChild(messageTime);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }
        
        // Health Dashboard Functions
        function refreshHealthData() {
            const refreshBtn = document.querySelector('.refresh-btn');
            if (!refreshBtn) return;
            
            refreshBtn.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                // Simulate data refresh
                updateHealthMetrics();
                refreshBtn.style.animation = '';
            }, 1000);
        }
        
        function updateHealthMetrics() {
            // Simulate real-time health data updates
            const metrics = document.querySelectorAll('.metric-value');
            metrics.forEach(metric => {
                metric.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    metric.style.transform = 'scale(1)';
                }, 200);
            });
        }
        
        
        // Chat Functions
        async function sendMessage() {
            console.log('sendMessage called');
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            console.log('Message:', message);
            
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            messageInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Send to AI backend
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                console.log('API Response:', data);
                hideTypingIndicator();
                
                if (data.status === 'success') {
                    console.log('Adding bot response:', data.response);
                    addMessage(data.response, 'bot');
                } else {
                    console.log('API Error:', data.error);
                    addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
                
            } catch (error) {
                console.error('Error sending message:', error);
                hideTypingIndicator();
                addMessage('Sorry, I\'m having trouble connecting. Please check your internet connection and try again.', 'bot');
            }
        }
        
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'flex';
            }
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }
        
        // File upload functionality
        function uploadFile(file) {
            console.log('Uploading file:', file.name, 'Size:', file.size);
            
            // Validate file size (max 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                addMessage('File size too large. Please upload files smaller than 10MB.', 'bot');
                return;
            }
            
            // Validate file type
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (!allowedTypes.includes(file.type)) {
                addMessage('Unsupported file type. Please upload PDF, JPG, PNG, or DOC files.', 'bot');
                return;
            }
            
            // Show upload progress
            addMessage(`📎 Uploading ${file.name}...`, 'user');
            showTypingIndicator();
            
            // Create FormData
            const formData = new FormData();
            formData.append('file', file);
            
            // Upload file
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                
                if (data.status === 'success') {
                    if (data.is_medical) {
                        addMessage(`✅ Medical document analyzed successfully!\n\n${data.analysis}`, 'bot');
                    } else {
                        addMessage(`❌ This doesn't appear to be a medical document. Please upload medical reports, prescriptions, or health-related documents.`, 'bot');
                    }
                } else {
                    addMessage(`❌ Error analyzing document: ${data.error}`, 'bot');
                }
            })
            .catch(error => {
                hideTypingIndicator();
                console.error('Upload error:', error);
                addMessage('❌ Failed to upload file. Please try again.', 'bot');
            });
        }
        
        // Initialize chat functionality
        function initializeChat() {
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            const attachmentButton = document.getElementById('attachmentButton');
            const fileInput = document.getElementById('fileInput');
            
            console.log('Initializing chat - sendButton:', sendButton, 'messageInput:', messageInput);
            
            if (sendButton && messageInput) {
                // Send message on button click
                sendButton.addEventListener('click', function() {
                    console.log('Send button clicked');
                    sendMessage();
                });
                
                // Send message on Enter key
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log('Enter key pressed');
                        sendMessage();
                    }
                });
                
                console.log('Event listeners attached successfully');
            } else {
                console.error('Could not find sendButton or messageInput elements');
            }
            
            // Attachment functionality
            if (attachmentButton && fileInput) {
                attachmentButton.addEventListener('click', function() {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        uploadFile(file);
                    }
                });
                
                console.log('Attachment functionality initialized');
            }
        }
        
        function showLoginPrompt() {
            // Create login prompt modal
            const loginModal = document.createElement('div');
            loginModal.className = 'login-modal';
            loginModal.innerHTML = `
                <div class="login-modal-content">
                    <div class="login-icon">
                        <i class="fas fa-user-lock"></i>
                    </div>
                    <div class="login-text">
                        <h2>Please Login First</h2>
                        <p>To access your personalized chat and connect with your historical medical history, please register or login first.</p>
                        <p class="login-benefit">This helps us assist you even better with personalized health insights!</p>
                    </div>
                    <div class="login-actions">
                        <button class="login-btn" onclick="goToRegistration()">
                            <i class="fas fa-user-plus"></i>
                            <span>Register Now</span>
                        </button>
                        <button class="back-btn" onclick="goToHome()">
                            <i class="fas fa-home"></i>
                            <span>Go to Home</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.appendChild(loginModal);
            
            // Show modal
            setTimeout(() => {
                loginModal.style.display = 'flex';
            }, 100);
        }
        
        function goToRegistration() {
            window.location.href = '/';
        }
        
        function goToHome() {
            window.location.href = '/';
        }
    </script>
</body>
</html>
